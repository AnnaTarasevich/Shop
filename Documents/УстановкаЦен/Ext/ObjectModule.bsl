Процедура ОбработкаПроведения(Отказ, Режим)
	//Сообщить("Начало процедуры ОбработкаПроведения. Режим: " + Режим);
    
        Если Установка.Количество() = 0 Тогда
            Сообщить("Ошибка: Табличная часть 'Установка' пуста!");
            Отказ = Истина;
            Возврат;
        КонецЕсли;
        
        ДатаПериода = ЭтотОбъект.Дата; 
        
        Для Каждого СтрокаУстановки Из Установка Цикл
            Попытка
				//Сообщить("Обработка строки: " + СтрокаУстановки.НоменклатураД);
                
                Если ТипЗнч(СтрокаУстановки.НоменклатураД) <> Тип("СправочникСсылка.НоменклатураСПР") Тогда
                    Сообщить("Ошибка: Некорректный тип данных для номенклатуры!");
                    Отказ = Истина;
                    Продолжить;
                КонецЕсли;
				
				Если СтрокаУстановки.НоваяЦенаЗакупочная = Неопределено ИЛИ СтрокаУстановки.НоваяЦенаРозничная = Неопределено Тогда
                    Сообщить("Ошибка: Не заполнены цены для " + СтрокаУстановки.НоменклатураД);
                    Отказ = Истина;
                    Продолжить;
                КонецЕсли;
                
                Запрос = Новый Запрос;
                Запрос.Текст = 
                    "ВЫБРАТЬ
                    |    ЦеныНаНоменклатуру.Номенклатура,
                    |    ЦеныНаНоменклатуру.Период,
                    |    ЦеныНаНоменклатуру.ЗакупочнаяЦена,
                    |    ЦеныНаНоменклатуру.РозничнаяЦена
                    |ИЗ
                    |    РегистрСведений.ЦеныНаНоменклатуру КАК ЦеныНаНоменклатуру
                    |ГДЕ
                    |    ЦеныНаНоменклатуру.Номенклатура = &Номенклатура";
                
                Запрос.УстановитьПараметр("Номенклатура", СтрокаУстановки.НоменклатураД);
                РезультатЗапроса = Запрос.Выполнить();
                
                Если РезультатЗапроса.Пустой() Тогда
					//Сообщить("Создание новой записи для: " + СтрокаУстановки.НоменклатураД);
                    НоваяЗапись = РегистрыСведений.ЦеныНаНоменклатуру.СоздатьМенеджерЗаписи();
                    НоваяЗапись.Номенклатура = СтрокаУстановки.НоменклатураД;
                    НоваяЗапись.Период = ДатаПериода;
                Иначе
					//Сообщить("Обновление существующей записи для: " + СтрокаУстановки.НоменклатураД);
                    Выборка = РезультатЗапроса.Выбрать();
                    Выборка.Следующий();
                    НоваяЗапись = РегистрыСведений.ЦеныНаНоменклатуру.СоздатьМенеджерЗаписи();
                    НоваяЗапись.Номенклатура = Выборка.Номенклатура;
                    НоваяЗапись.Период = Выборка.Период;
                КонецЕсли;
                
                НоваяЗапись.ЗакупочнаяЦена = СтрокаУстановки.НоваяЦенаЗакупочная;
                НоваяЗапись.РозничнаяЦена = СтрокаУстановки.НоваяЦенаРозничная;
                
                НоваяЗапись.Записать();
				//Сообщить("Данные сохранены для: " + СтрокаУстановки.НоменклатураД);
                
            Исключение
                Сообщить("Ошибка для " + СтрокаУстановки.НоменклатураД + ": " + ОписаниеОшибки());
                Отказ = Истина;
            КонецПопытки;
        КонецЦикла;
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка) 
    Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПоставляемаяНоменклатура") Тогда
        Для Каждого ТекСтрокаПоставка Из ДанныеЗаполнения.Поставка Цикл
            // Получаем дату периода (например, из текущего документа)
            ДатаПериода = ЭтотОбъект.Дата; 
            
            // Ищем запись в регистре по Номенклатуре и Периоду
            Запрос = Новый Запрос;
            Запрос.Текст = 
                "ВЫБРАТЬ
                |    ЦеныНаНоменклатуру.Номенклатура,
                |    ЦеныНаНоменклатуру.ЗакупочнаяЦена,
                |    ЦеныНаНоменклатуру.РозничнаяЦена
                |ИЗ
                |    РегистрСведений.ЦеныНаНоменклатуру КАК ЦеныНаНоменклатуру
                |ГДЕ
                |    ЦеныНаНоменклатуру.Номенклатура = &Номенклатура";            
            Запрос.УстановитьПараметр("Номенклатура", ТекСтрокаПоставка.Номенклатура);
            РезультатЗапроса = Запрос.Выполнить();

            СтараяЗакупочнаяЦена = 0;
            СтараяРозничнаяЦена = 0;
            Если РезультатЗапроса.Пустой() Тогда
                // Если записи нет, оставляем поля пустыми
            Иначе
                Выборка = РезультатЗапроса.Выбрать();
                Выборка.Следующий();
                СтараяЗакупочнаяЦена = Выборка.ЗакупочнаяЦена;
                СтараяРозничнаяЦена = Выборка.РозничнаяЦена;
            КонецЕсли;

            // Добавляем строку в табличную часть
            НоваяСтрока = Установка.Добавить();
            НоваяСтрока.НоменклатураД = ТекСтрокаПоставка.Номенклатура;
            НоваяСтрока.СтараяЦенаЗакупочная = СтараяЗакупочнаяЦена;
            НоваяСтрока.НоваяЦенаЗакупочная = ТекСтрокаПоставка.Цена;
            НоваяСтрока.СтараяЦенаРозничная = СтараяРозничнаяЦена;
		КонецЦикла;
    КонецЕсли;
КонецПроцедуры

